<!DOCTYPE html>

<html>
  
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="/css/signin.css">
    <title>Find login</title>

  </head>

  <body>

	  	<header>
	  		<div class="headertopic">
	  			<div class="headerleft">
            <div>Find 師傅 - 家務修繕小幫手，師傅接案好輕鬆</div>
	  			</div>
	  			<div class="headeright">
            <a href="/"><div id="index">回首頁</div></a>
		  			<a href="signup-customer.html"><div id="signuplinkcustomer">註冊-找幫手</div></a>
		  			<a href="signup-master.html"><div id="signuplinkmaster">註冊-當師傅</div></a>
	  			</div>
	  		</div>
	  	</header>

	  	<div class="uparea"></div>

  		<main>

	  		<div id="login">
	  			<div id="chooserole">
		  			<div id="signinform"><button id="changetoin" onclick="Customer()">我在找幫手</button></div>
		  			<div id="signupform"><button id="changetoup" onclick="Master()">我是師傅</button></div>
	  			</div>

  				<div id="inputdata">
  				
  					<div id="inputleft">
				        <label id='phonelabel'>手機號碼 ( Phone Number )：</label>
				        <label id="passwordlabel">密碼 ( Password )：</label>
			        </div>
			        
			        <div id="inputright">
			        	<input id="phone" type="text" name="phone" placeholder='ex: 0910999999' maxlength="10" minlength="10">
			        	<input id="password" type="password" name="password" maxlength="10" minlength="8">
			        </div>        
		          			
  				</div>

	  			<div id='buttons'>
				      <div id='signinbutton'><button id='signin' type="submit" onclick="SignIn()">登入 ( Sign In )</button></div>  
	  			</div>
	  		</div>


	  	</main>

    <script>

      let rolecustomer = document.getElementById('changetoin');
      let rolemaster = document.getElementById('changetoup');
      let inputphone = document.getElementById('phone');
      let inputpass = document.getElementById('password');

    	function Customer(){

        rolecustomer.style.backgroundColor = '#EFE6DD';
        rolemaster.style.backgroundColor = '#FFFFFF';
        inputphone.value = '' ;
        inputpass.value = '';

    	}

      function Master(){
  
        rolecustomer.style.backgroundColor =  '#FFFFFF';
        rolemaster.style.backgroundColor = '#EFE6DD';
        inputphone.value = '' ;
        inputpass.value = '';

      }

      function SignIn(){

        var signinData = new XMLHttpRequest();
      
        signinData.onreadystatechange=function(){

          if(signinData.readyState === 4){
            
           if (signinData.status === 200){

              let signinback = JSON.parse(signinData.responseText);

              if( signinback.error != null ){

                alert('手機號碼/密碼錯誤 ( phone/password incorrect ) ');

              }else if( signinback.message ){

                alert('帳號未啟用 ( account not active )');

              }else{

                let backtoken = "Bearer " + signinback.data.access_token;         

                sessionStorage.setItem("Auth",backtoken);

                let lastpageurl = document.referrer ;

                console.log(lastpageurl);

                if(signinback.data.provider == 'customer'){

                  if( lastpageurl.indexOf('signup') > -1 || lastpageurl.indexOf('g777708.com') == -1 || lastpageurl.indexOf('errordirect') > -1 || lastpageurl == 'https://g777708.com/' ){

                    window.location.replace('searchcustomerorder.html');

                  }else{

                    window.location.replace(lastpageurl);

                  }    

                }else{

                  if( lastpageurl.indexOf('signup') > -1 || lastpageurl.indexOf('g777708.com') == -1 || lastpageurl.indexOf('errordirect') > -1 || lastpageurl.indexOf('mailverify') > -1 || lastpageurl.indexOf('mailsend') > -1 || lastpageurl == 'https://g777708.com/' ){

                    window.location.replace('searchmasterorder.html');

                  }else{

                    window.location.replace(lastpageurl);

                  }                  

                }
            
              }

            }
   
          }

        };

        signinData.open('POST','/api/user/signin');

        signinData.setRequestHeader("Content-Type",
              "application/json");

        let rolecustomer = document.getElementById('changetoin');
        let inputphone = document.getElementById('phone').value;
        let inputpass = document.getElementById('password').value;

        let jsonsend = {};
        jsonsend.phone = inputphone;
        jsonsend.password = inputpass;

        if( rolecustomer.style.backgroundColor == 'rgb(239, 230, 221)' ){
          
          jsonsend.provider = 'customer';

        }else if(rolecustomer.style.backgroundColor == ''){

          jsonsend.provider = 'customer';

        }else{

          jsonsend.provider = 'master';

        }

        let sendjson = JSON.stringify(jsonsend);

        signinData.send(sendjson);

      }

    </script>

  </body>
  
  <footer class="footer">

  		<p class="footerp">&copy;2019. All rights reserved.</p>

  </footer>

</html>
